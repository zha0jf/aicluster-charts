{{- if and .Values.automation.enabled .Values.automation.confirmDanger }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gpu-labeler-sa
  namespace: {{ .Values.namespace }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: gpu-labeler-role
rules:
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "patch", "update"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: gpu-labeler-binding
subjects:
  - kind: ServiceAccount
    name: gpu-labeler-sa
    namespace: {{ .Values.namespace }}
roleRef:
  kind: ClusterRole
  name: gpu-labeler-role
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: gpu-node-labeler
  namespace: {{ .Values.namespace }}
spec:
  selector:
    matchLabels:
      app: gpu-node-labeler
  template:
    metadata:
      labels:
        app: gpu-node-labeler
    spec:
      serviceAccountName: gpu-labeler-sa
      hostNetwork: true
      nodeSelector:
        {{- toYaml .Values.automation.nodeSelector | nindent 8 }}
      containers:
      - name: labeler
        image: {{ .Values.automation.image }}
        imagePullPolicy: IfNotPresent
        command:
          - /bin/sh
          - -c
          - |
            echo "Starting Labeler on $NODE_NAME"
            # 确保使用完整路径或镜像中包含 kubectl
            if ! command -v kubectl &> /dev/null; then
                echo "Error: kubectl not found in this image"
                exit 1
            fi

            CONFIG_KEY="{{ .Values.strategy.configName }}"
            MODE="{{ .Values.strategy.mode }}"
            
            # 定义标签键名
            L_DP="nvidia.com/device-plugin.config"
            L_MIG="nvidia.com/mig.config"

            if [ "$MODE" = "time-slicing" ]; then
                # Time-Slicing 模式：
                # 1. 确保 Device Plugin 读取配置
                # 2. 确保 MIG Manager 不工作 (删除 MIG 标签)
                kubectl label node $NODE_NAME $L_DP=$CONFIG_KEY --overwrite
                kubectl label node $NODE_NAME $L_MIG- --overwrite 2>/dev/null || true
                
            elif [ "$MODE" = "mig-single" ] || [ "$MODE" = "mig-mixed" ]; then
                # MIG 模式：
                # 1. 确保 MIG Manager 读取分区配置
                # 2. 确保 Device Plugin 读取策略配置 (不要删除 L_DP)
                kubectl label node $NODE_NAME $L_MIG=$CONFIG_KEY --overwrite
                kubectl label node $NODE_NAME $L_DP=$CONFIG_KEY --overwrite
            fi
            
            echo "Done. Labels updated. Sleeping..."
            sleep infinity
        env:
          - name: NODE_NAME
            valueFrom:
              fieldRef:
                fieldPath: spec.nodeName
{{- end }}
