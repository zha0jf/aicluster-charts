{{- /* 1. é¢„è®¡ç®—æ ‡ç­¾ Keyï¼Œç”¨äºæ‰‹åŠ¨å‘½ä»¤ç”Ÿæˆ */ -}}
{{- $labelKey := "" -}}
{{- if eq .Values.strategy.mode "time-slicing" -}}
  {{- $labelKey = "nvidia.com/device-plugin.config" -}}
{{- else -}}
  {{- $labelKey = "nvidia.com/mig.config" -}}
{{- end -}}

========================================================================
   NVIDIA GPU åˆ†ç‰‡ç­–ç•¥ç®¡ç†å™¨ (v3.1.0) å·²éƒ¨ç½²
========================================================================

é…ç½®åç§° (Config Name): {{ .Values.strategy.configName }}
åˆ†ç‰‡æ¨¡å¼ (Mode):        {{ .Values.strategy.mode }}
ç›®æ ‡å‘½åç©ºé—´:           {{ .Values.namespace }}


{{- if and .Values.automation.enabled .Values.automation.confirmDanger }}
------------------------------------------------------------------------
[è‡ªåŠ¨åŒ–æ‰§è¡ŒçŠ¶æ€æŠ¥å‘Š]
------------------------------------------------------------------------
âœ… [å·²æ‰§è¡Œ] å…¨è‡ªåŠ¨åŒ–æµç¨‹å·²å¯åŠ¨ (Automation Active)

   1. èŠ‚ç‚¹æ‰“æ ‡ç­¾ (DaemonSet):
      - çŠ¶æ€: å·²éƒ¨ç½²
      - ç›®æ ‡: æ‰€æœ‰æ ‡ç­¾ä¸º 'nvidia.com/gpu.present: true' çš„èŠ‚ç‚¹ã€‚
      - åŠ¨ä½œ: è‡ªåŠ¨æ¸…ç†å†²çªæ ‡ç­¾å¹¶åº”ç”¨æ–°ç­–ç•¥ã€‚

   2. ç­–ç•¥åº”ç”¨ (ClusterPolicy Patch):
      - çŠ¶æ€: Job å·²è§¦å‘
      - åŠ¨ä½œ: ä¿®æ”¹ ClusterPolicy '{{ .Values.automation.policyName }}' æŒ‡å‘ 'gpu-slicing-config'ã€‚

   ğŸ•’ [åç»­æ­¥éª¤]:
      è¯·ç­‰å¾… 1-2 åˆ†é’Ÿï¼ŒNVIDIA GPU Operator ä¼šæ£€æµ‹åˆ°å˜æ›´å¹¶é‡å¯ Device Pluginã€‚
      å¦‚æœæ˜¯ MIG æ¨¡å¼ï¼ŒèŠ‚ç‚¹ GPU å°†ä¼šé‡ç½®ã€‚

{{- else if .Values.automation.enabled }}
âš ï¸ [è¢«æ‹¦æˆª] è‡ªåŠ¨åŒ–è¢«é˜»æ­¢ (Blocked)

   åŸå› : æ‚¨å‹¾é€‰äº†â€œå¯ç”¨è‡ªåŠ¨åŒ–â€ï¼Œä½†æœªå‹¾é€‰â€œé«˜å±ç¡®è®¤ (High Risk Confirm)â€ã€‚
   ç»“æœ: ä¸ºäº†ä¿æŠ¤ç”Ÿäº§ç¯å¢ƒï¼Œä»»ä½•ä¿®æ”¹ï¼ˆæ‰“æ ‡ç­¾/æ”¹Policyï¼‰å‡æœªæ‰§è¡Œã€‚

{{- else }}
â„¹ï¸ [æ‰‹åŠ¨æ¨¡å¼] è‡ªåŠ¨åŒ–æœªå¯ç”¨ (Manual Mode)

   ç³»ç»Ÿä»…åˆ›å»ºäº† ConfigMapï¼Œæœªä¿®æ”¹ä»»ä½•èŠ‚ç‚¹æˆ–ç­–ç•¥ã€‚
{{- end }}

{{- if not (and .Values.automation.enabled .Values.automation.confirmDanger) }}
------------------------------------------------------------------------
[æ‰‹åŠ¨æ“ä½œæŒ‡å—]
------------------------------------------------------------------------
è‹¥è‡ªåŠ¨åŒ–æœªæ‰§è¡Œï¼Œè¯·ä¾æ¬¡æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹ä¸¤æ­¥ï¼Œä½¿ç­–ç•¥ç”Ÿæ•ˆï¼š

æ­¥éª¤ 1: ä¿®æ”¹ ClusterPolicy ä»¥åŠ è½½é…ç½®
---------------------------------------------------
è¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå‘Šè¯‰ GPU Operator ä½¿ç”¨æœ¬æ¬¡éƒ¨ç½²çš„é…ç½®ï¼š

kubectl patch clusterpolicy {{ .Values.automation.policyName }} \
  --type=merge \
  -p '{"spec": {"devicePlugin": {"config": {"name": "gpu-slicing-config", "default": ""}}}}'


æ­¥éª¤ 2: ç»™ç‰¹å®šèŠ‚ç‚¹æ‰“æ ‡ç­¾
---------------------------------------------------
è¯·å°†ç­–ç•¥åº”ç”¨åˆ°æ‚¨æŒ‡å®šçš„ GPU èŠ‚ç‚¹ï¼š

kubectl label node <æ‚¨çš„èŠ‚ç‚¹åç§°> {{ $labelKey }}={{ .Values.strategy.configName }} --overwrite

æ³¨æ„:
* å¦‚æœæ˜¯ Time-Slicing: æ ‡ç­¾ä¸º nvidia.com/device-plugin.config
* å¦‚æœæ˜¯ MIG:          æ ‡ç­¾ä¸º nvidia.com/mig.config
{{- end }}

========================================================================
